<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: header"/>
<style>
    .character-info {
        position: relative;
        width: 400px;
        height: 170px;
        overflow: hidden;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        color: white;
        cursor: pointer;
    }

    .character-content-box {
        width: 400px;
        border-bottom-left-radius: 10px;
        border-bottom-right-radius: 10px;
        font-size: large;
        margin-bottom: 15px;
        cursor: pointer;
    }

    .character-content-box .chaos-content {
        height: 80px;
        padding-left: 30px;
        padding-top: 10px;
        background-color: #bacbe6;
    }

    .character-content-box .guardian-content {
        height: 80px;
        padding-left: 30px;
        padding-top: 10px;
        background-color: #fff3cd;
    }

    .character-info-box {
        position: absolute;
        padding-left: 30px;
        padding-top: 20px;
    }

    .character-img {
        position: absolute;
        top: -90px;
        left: -25px;
    }


</style>
<body>
<div th:replace="fragments/nav :: nav"/>
<div class="row row-cols-2" style="margin-left: 15px;">
    <div class="col-md-9">
        <div style="margin-bottom: 10px;">
            <h2>숙제 체크</h2>
            <!--            <input class="btn btn-info" type="button" th:onclick="updateCharacters()" value="캐릭터 정보 갱신">-->
        </div>
        <div class="row row-cols-4">
            <div class="col-md-3" th:name="characterInfo" th:each="character : ${characters}">
                <div class="character-info" th:onclick="saveTodo([[${character.characterName}]])">
                    <div class="character-img-box">
                        <img th:styleappend="${character.characterClassName == '기상술사' || character.characterClassName == '도화가' ? 'top: -180px' : ''}"
                             class="character-img" th:src="${character.characterImage}">
                    </div>
                    <div class="character-info-box">
                        <p th:name="characterClassName" th:text="${character.characterClassName}"></p>
                        <h5 th:name="characterName" th:text="${character.characterName}"></h5>
                        <h3 th:name="itemLevel" th:text="'Lv.'+${character.itemLevel}"></h3>
                    </div>
                </div>
                <div class="character-content-box" th:name="character-dayContent">
                    <div class="chaos-content" th:name="chaosContent"
                         th:styleappend="|${character.chaosCheck == 2 ? 'text-decoration:line-through; color: #dddddd; background-color: #808080;' : ''}
                        ${character.chaosSelected ? ''  : 'background-color: #cccccc; text-decoration:line-through; height: 40px;'}|"
                    th:onclick="updateDayContentSelected([[${character.characterName}]], [[!${character.chaosSelected}]], [[${character.guardianSelected}]])">
                        카오스던전 : <span th:name="chaosName" th:id="${character.characterName}+'_chaosName'"
                                      th:text="${character.chaosName}"></span>
                        [예상수익 : <span th:name="chaosProfit" th:id="${character.characterName}+'_chaosProfit'"
                                      th:text="${character.chaosProfit}"></span>]
                        <div th:if="${character.chaosSelected}">
                            휴식게이지: <input type="number" th:name="chaosGauge"
                                          th:id="${character.characterName}+'_chaosGauge'"
                                          th:value="${character.chaosGauge}" style="width: 50px" min="0" max="100"
                                          step="10">
                            <input class="btn btn-info" th:name="chaosChecked" type="button" th:value="${character.chaosCheck}+'수'"
                            th:onclick="changeChaosCount(${character.characterName})">
                        </div>
                        <div th:if="!${character.chaosSelected}">
                            <input type="hidden" th:name="chaosGauge" th:id="${character.characterName}+'_chaosGauge'"
                                   th:value="${character.chaosGauge}">
                        </div>
                    </div>
                    <div class="guardian-content" th:name="guardianContent"
                         th:styleappend="|${character.guardianCheck == 2 ? 'text-decoration:line-through; color: #dddddd; background-color: #808080;' : ''}
                         ${character.guardianSelected ? ''  : 'background-color: #cccccc; text-decoration:line-through; height: 40px;'}|"
                         th:onclick="updateDayContentSelected([[${character.characterName}]], [[${character.chaosSelected}]], [[!${character.guardianSelected}]])">
                        가디언토벌 : <span th:name="guardianName" th:id="${character.characterName}+'_guardianName'"
                                      th:text="${character.guardianName}"></span>
                        [예상수익 : <span th:name="guardianProfit" th:id="${character.characterName}+'_guardianProfit'"
                                      th:text="${character.guardianProfit}"></span>]
                        <div th:if="${character.guardianSelected}">
                            휴식게이지: <input type="number" th:name="guardianGauge"
                                          th:id="${character.characterName}+'_guardianGauge'"
                                          th:value="${character.guardianGauge}" style="width: 50px" min="0" max="100"
                                          step="10">
                            <input class="btn btn-info" th:name="guardianChecked" type="button" th:value="${character.guardianCheck}+'수'">
                        </div>
                        <div th:if="!${character.guardianSelected}">
                            <input type="hidden" th:name="guardianGauge"
                                   th:id="${character.characterName}+'_guardianGauge'"
                                   th:value="${character.guardianGauge}">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div>
            <h2>일일 숙제 수익</h2>
            <h5 th:text="'총 예상 '+${sumDayContentProfit}+' Gold'"></h5>
            <div th:each="profit : ${sortDayContentProfit}" th:name="profit-list"
                 style="box-shadow: rgba(0, 0, 0, 0.4) 0px 2px 4px, rgba(0, 0, 0, 0.3) 0px 7px 13px -3px, rgba(0, 0, 0, 0.2) 0px -3px 0px inset; padding: 5px; cursor: pointer;"
                 th:styleappend="|${profit.checked == 2 ? 'text-decoration: line-through; color: #dddddd; box-shadow: rgba(50, 50, 93, 0.25) 0px 30px 60px -12px inset, rgba(0, 0, 0, 0.3) 0px 18px 36px -18px inset;' : ''}
                 ${profit.category == '카오스던전' ? 'background-color: #bacbe6;' : ''}
                 ${profit.category == '가디언토벌' ? 'background-color: #fff3cd;' : ''}|"
                 th:onclick="changeProfit([[${profit.characterName}]], [[${profit.category}]])">
                <span th:text="${profit.characterName} + ' / ' + ${profit.category}"></span><br>
                <span th:text="${profit.contentName} + ':' + ${profit.profit} + ' gold'"></span>
            </div>
        </div>
    </div>
</div> <!-- /container -->
</body>
<script>

    var profitList = document.querySelectorAll('div[name="profit-list"]');

    profitList.forEach(function (content) {
        content.addEventListener('mousedown', function () {
            content.style.transform = 'scale(0.95)';
        });

        content.addEventListener('mouseup', function () {
            content.style.transform = 'scale(1)';
        });

        content.addEventListener('mouseover', function () {
            var before = content.style.color;
            content.style.color = 'gray';
            content.addEventListener('mouseout', function () {
                content.style.color = before;
            });
        });


    });

    function updateDayContentSelected(characterName, chaosSelected, guardianSelected) {
        var data = {
            chaosSelected: chaosSelected,
            guardianSelected: guardianSelected
        }
        $.ajax("/api/character/dayContent/selected/" + characterName,
            {
                method: 'patch',
                contentType: 'application/json',
                data: JSON.stringify(data),
                dataType: 'json'
            })
            .done(function (result) {
                location.reload();
            })
            .fail(function (request, status, error) {
                location.reload();
            });
    }

    function changeProfit(characterName, category) {
        console.log(characterName, category);
        var data = {
            characterName: characterName,
            category: category
        }
        $.ajax("/api/character/dayContent",
            {
                method: 'patch',
                contentType: 'application/json',
                data: JSON.stringify(data),
                dataType: 'json'
            })
            .done(function (result) {
                location.reload();
            })
            .fail(function (request, status, error) {
                console.log(error);
            });
    }

    function makeData(characterName) {
        var characterInfoElements = document.querySelectorAll('div[name="characterInfo"]');
        var characterInfoElement;

        for (var i = 0; i < characterInfoElements.length; i++) {
            var nameElement = characterInfoElements[i].querySelector('h5[name="characterName"]');
            if (nameElement.textContent === characterName) {
                characterInfoElement = characterInfoElements[i];
                break;
            }
        }

        if (!characterInfoElement) {
            console.error('Character not found.');
            return;
        }

        var characterDayContentElement = characterInfoElement.children[1];
        var chaosContentElement = characterDayContentElement.querySelector('[name="chaosContent"]');
        var guardianContentElement = characterDayContentElement.querySelector('[name="guardianContent"]');


        var chaos = 0;
        if (chaosContentElement.querySelector('input[type="number"]') == null) {
            var chaosGauge = parseInt(chaosContentElement.querySelector('input[type="hidden"]').value);
        } else {
            var chaosGauge = parseInt(chaosContentElement.querySelector('input[type="number"]').value);
        }
        if (chaosContentElement.querySelector('[name="chaosChecked"]:checked')) {
            chaos = chaosContentElement.querySelectorAll('[name="chaosChecked"]:checked').length;
        }

        var guardian = 0;
        if (guardianContentElement.querySelector('input[type="number"]') == null) {
            var guardianGauge = parseInt(guardianContentElement.querySelector('input[type="hidden"]').value);
        } else {
            var guardianGauge = parseInt(guardianContentElement.querySelector('input[type="number"]').value);

        }
        if (guardianContentElement.querySelector('[name="guardianChecked"]:checked')) {
            guardian = guardianContentElement.querySelectorAll('[name="guardianChecked"]:checked').length;
        }

        var character = {
            characterName: characterName,
            chaos: chaos,
            chaosGauge: chaosGauge,
            guardian: guardian,
            guardianGauge: guardianGauge
        };

        console.log(character);
        return JSON.stringify(character);
    }



    function saveTodo(characterName) {
        var data = makeData(characterName);
        $.ajax("/api/character",
            {
                method: 'patch',
                contentType: 'application/json',
                data: data,
                dataType: 'json'
            })
            .done(function (result) {
                console.log(result);
            })
            .fail(function (error) {
                alert(error.responseJSON.message);
            });
    }

    function updateCharacters() {
        var url = window.location.href.split('/');
        var username = url[url.length - 1];
        $.ajax("/api/lostark/character/" + username,
            {
                method: 'patch',
                contentType: 'application/json',
                headers: {},
                dataType: 'json'
            })
            .done(function (result) {
                location.reload();
            })
            .fail(function (request, status, error) {
                alert(error.responseJSON.message);
            });
    }

    function changeChaosCount(characterName) {

    }
</script>
</html>