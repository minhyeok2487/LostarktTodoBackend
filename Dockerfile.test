# Stage 1: Build
FROM public.ecr.aws/amazoncorretto/amazoncorretto:17-al2023 AS builder

RUN yum install -y findutils tar gzip

WORKDIR /app
COPY gradlew .
COPY gradle gradle
COPY build.gradle .
COPY settings.gradle .
COPY src src

RUN chmod +x gradlew

# 테스트 환경: AWS Parameter Store를 optional로 변경
RUN sed -i 's|spring.config.import=aws-parameterstore:|spring.config.import=optional:aws-parameterstore:|' src/main/resources/application.properties

RUN ./gradlew bootJar -x test --no-daemon

# Stage 2: Run (production-identical settings)
FROM public.ecr.aws/amazoncorretto/amazoncorretto:17-al2023-headless

RUN yum update -y && yum install -y procps
RUN ln -snf /usr/share/zoneinfo/Asia/Seoul /etc/localtime

COPY --from=builder /app/build/libs/todo-0.0.1-SNAPSHOT.jar app.jar

ENV PORT 8080
EXPOSE $PORT

ENTRYPOINT ["java", \
  "-Xms256m", \
  "-Xmx512m", \
  "-XX:MaxMetaspaceSize=160m", \
  "-XX:+UseG1GC", \
  "-XX:MaxGCPauseMillis=200", \
  "-XX:+UseStringDeduplication", \
  "-XX:NativeMemoryTracking=summary", \
  "-jar", "app.jar", \
  "--spring.profiles.active=test"]
